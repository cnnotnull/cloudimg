# 文件命名规则说明

## 概述

本系统现在使用 **SHA256 哈希值** 作为文件名，而不是使用原始文件名。这种做法在对象存储（如 S3、Cloudflare R2）中是最佳实践。

## 为什么使用 SHA256 作为文件名？

### 1. 避免文件名冲突
原始文件名可能重复，例如多个用户都上传 `image.jpg`。使用 SHA256 可以确保每个文件都有唯一的文件名。

### 2. 避免特殊字符问题
原始文件名可能包含特殊字符、空格、非 ASCII 字符等，这些字符在某些存储系统中可能导致问题。SHA256 只包含十六进制字符（0-9, a-f），完全兼容所有存储系统。

### 3. 自动去重
系统在文件上传前会计算 SHA256，如果文件已存在，则不会重复上传，直接返回现有文件的 URL。这节省了存储空间和带宽。

### 4. 安全性
文件名不泄露原始文件信息，提供更好的隐私保护。

### 5. 缓存友好
相同内容的文件（即使原始文件名不同）会产生相同的 SHA256，因此 CDN 和浏览器缓存可以更有效地工作。

## 文件命名规则

### 默认路径规则
默认路径规则为：`uploads/{date}/{filename}.{ext}`

### 实际生成的路径示例

假设上传文件 `photo.jpg`，其 SHA256 为 `a1b2c3d4e5f6...`，在 2026-01-29 上传：

**存储路径：**
```
uploads/20260129/a1b2c3d4e5f6...jpg
```

**完整 URL（使用自定义域名）：**
```
https://image.notnull.com.cn/uploads/20260129/a1b2c3d4e5f6...jpg
```

## 路径规则变量

系统支持以下变量来自定义存储路径：

| 变量 | 说明 | 示例 |
|------|------|------|
| `{date}` | 日期（YYYYMMDD） | 20260129 |
| `{year}` | 年份 | 2026 |
| `{month}` | 月份 | 01 |
| `{day}` | 日期 | 29 |
| `{sha256}` | SHA256 哈希值（完整64字符） | a1b2c3d4e5f6... |
| `{filename}` | 文件名（优先使用 SHA256） | a1b2c3d4e5f6... |
| `{ext}` | 文件扩展名（小写） | jpg |

## 自定义路径规则示例

### 按年月分目录
```json
{
  "path_rule": "{year}/{month}/{sha256}.{ext}"
}
```

生成的路径：
```
2026/01/a1b2c3d4e5f6...jpg
```

### 直接使用 SHA256（不分目录）
```json
{
  "path_rule": "{sha256}.{ext}"
}
```

生成的路径：
```
a1b2c3d4e5f6...jpg
```

### 使用完整 SHA256（64 字符）
```json
{
  "path_rule": "full/{sha256}.{ext}"
}
```

生成的路径：
```
full/a1b2c3d4e5f6789abcdef1234567890abcdef1234567890abcdef1234567890.jpg
```

## 原始文件名保留

虽然存储文件名使用 SHA256，但系统仍然保留原始文件名信息：

**数据库记录：**
```json
{
  "id": 123,
  "original_filename": "photo.jpg",      // 原始文件名
  "storage_filename": "uploads/20260129/a1b2c3d4e5f6...jpg",  // 存储路径
  "sha256": "a1b2c3d4e5f6...",             // SHA256 哈希值
  "original_url": "https://image.notnull.com.cn/uploads/20260129/a1b2c3d4e5f6...jpg"
}
```

## 文件去重机制

系统通过 SHA256 自动检测重复文件：

1. 用户上传文件
2. 计算文件的 SHA256 哈希值
3. 检查数据库中是否已存在相同 SHA256 的文件
4. 如果存在，返回现有文件的 URL（不重复上传）
5. 如果不存在，使用 SHA256 作为文件名上传

**示例：**
```
用户 A 上传 "photo.jpg" → 系统存储为 "a1b2c3d4e5f6...jpg"
用户 B 上传 "pic.jpg"（内容相同）→ 系统检测到 SHA256 相同，直接返回 A 的文件 URL
```

## 注意事项

1. **文件扩展名保留**：虽然文件名使用 SHA256，但文件扩展名（如 .jpg, .png）仍然保留，确保文件类型正确。

2. **SHA256 唯一性**：SHA256 是加密哈希算法，碰撞概率极低，可以认为是唯一的。

3. **性能影响**：计算 SHA256 需要一定时间，但现代计算机计算速度很快，对用户体验影响很小。

4. **向后兼容**：系统仍然支持 `{filename}` 变量，但在上传时会优先使用 SHA256。

5. **存储配置**：在存储引擎配置中，可以通过 `path_rule` 参数自定义路径规则。

## 迁移说明

如果之前使用的是原始文件名，新上传的文件将自动使用 SHA256。旧文件不受影响，可以继续访问。

如果需要将旧文件迁移到新命名规则，需要：
1. 下载所有旧文件
2. 重新上传（系统会自动使用 SHA256）
3. 更新数据库中的 `storage_filename` 字段

## 示例代码

### 创建存储引擎时自定义路径规则

```python
from app.services.storage import StorageService

# 使用自定义路径规则
storage = StorageEngineCreate(
    name="我的 S3 存储",
    type="s3",
    config={
        "endpoint_url": "https://...",
        "access_key_id": "...",
        "secret_access_key": "...",
        "bucket_name": "my-bucket",
        "custom_domain": "https://cdn.example.com"
    },
    path_rule="{year}/{month}/{day}/{sha256}.{ext}",  # 自定义路径规则
    is_active=True
)
```

## 常见问题

### Q: SHA256 文件名太长怎么办？

A: SHA256 是 64 个字符，这是标准长度。大多数存储系统（包括 S3、R2）都支持长文件名。如果需要缩短，可以使用路径规则中的 `{filename}`，但仍然会使用 SHA256。

### Q: 用户下载文件时看到的是 SHA256 文件名吗？

A: 是的，下载的文件名会是 SHA256 加上扩展名。如果需要保留原始文件名，可以在下载时通过 HTTP 响应头 `Content-Disposition` 设置。

### Q: 如何恢复原始文件名？

A: 数据库中保留了 `original_filename` 字段，可以随时查询。如果需要让用户下载时看到原始文件名，可以在下载接口中设置响应头。

### Q: 文件扩展名重要吗？

A: 是的，扩展名很重要。系统会根据文件内容验证类型，但扩展名帮助浏览器和其他应用识别文件类型。系统会从原始文件名中提取扩展名并保留。
